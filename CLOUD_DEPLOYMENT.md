# 微信云开发后端部署指南

## 前置准备

1. **开通云开发**
   - 打开微信开发者工具
   - 点击工具栏的「云开发」按钮
   - 按照提示开通云开发服务（选择免费版即可）

2. **创建云环境**
   - 在云开发控制台创建环境
   - 记录环境ID（后续配置需要）

3. **配置消息模板**
   - 登录微信公众平台（mp.weixin.qq.com）
   - 进入「订阅消息」→「我的模板」
   - 选择「充电桩空闲提醒」类模板或自定义模板
   - 模板内容示例：
     ```
     充电桩名称：{{thing1.DATA}}
     空闲数量：{{number2.DATA}}
     总数量：{{number3.DATA}}
     提醒时间：{{date4.DATA}}
     ```
   - 记录模板ID（替换代码中的 `ppFGwoeA7oxrF0f69dZEYTje1AkUBKqGoq05hJIanYs`）

## 部署步骤

### 1. 初始化云开发环境

在微信开发者工具中：
1. 右键点击 `cloudfunctions` 目录
2. 选择「当前环境」→ 选择你创建的云环境
3. 等待初始化完成

### 2. 创建数据库集合

在云开发控制台：
1. 进入「数据库」
2. 创建以下集合：
   - `subscribes` - 订阅记录
   - `stationHistory` - 充电桩状态历史
3. 设置数据库权限规则：
   ```json
   {
     "read": "auth.openid == doc._openid",
     "write": "auth.openid == doc._openid"
   }
   ```

### 3. 上传云函数

在微信开发者工具中：
1. 右键点击每个云函数目录
2. 选择「上传并部署：云端安装依赖」
3. 按以下顺序上传：
   - `subscribe`
   - `getUserInfo`
   - `checkStationStatus`
   - `sendNotification`
   - `checkAndNotify`

### 4. 配置定时触发器

在云开发控制台：
1. 进入「云函数」→「checkAndNotify」
2. 点击「触发器」→「添加触发器」
3. 配置：
   - 触发方式：定时触发
   - Cron表达式：`0 */3 * * * * *`（每3分钟执行一次）
   - 或使用 `config.json` 文件自动配置

### 5. 测试功能

#### 测试订阅功能
1. 在小程序中收藏几个充电桩
2. 进入「用户」页面
3. 开启「消息提醒」开关
4. 同意订阅消息授权
5. 检查云数据库 `subscribes` 集合是否有记录

#### 测试定时检测
1. 在云开发控制台查看云函数日志
2. 等待3分钟后，检查 `checkAndNotify` 是否执行
3. 查看是否有充电桩状态变化

#### 测试消息推送
1. 手动触发 `checkAndNotify` 云函数
2. 检查微信是否收到订阅消息

## 常见问题

### 1. 云函数上传失败
- 检查网络连接
- 确认云环境已开通
- 查看错误日志

### 2. 订阅消息发送失败
- 确认模板ID正确
- 确认用户已授权
- 检查access_token是否有效

### 3. 定时触发器不工作
- 确认触发器配置正确
- 检查Cron表达式格式
- 查看云函数日志

### 4. 数据库权限错误
- 检查数据库权限规则
- 确认用户已登录

## 注意事项

1. **订阅消息限制**
   - 一次性订阅：用户授权后只能发一条消息
   - 长期订阅：需要特殊资质（企业账号）
   - 当前实现使用一次性订阅，需要用户定期重新授权

2. **免费额度**
   - 云函数调用次数：100万次/月
   - 数据库读写次数：500万次/月
   - CDN流量：5GB/月
   - 超出后需要付费

3. **消息模板**
   - 需要在微信公众平台配置
   - 模板内容需要符合规范
   - 避免发送营销类消息

## 优化建议

1. **性能优化**
   - 添加数据库索引
   - 批量处理数据
   - 缓存常用数据

2. **用户体验**
   - 提供订阅到期提醒
   - 支持批量订阅
   - 添加订阅历史查看

3. **监控告警**
   - 设置云函数告警
   - 监控数据库使用量
   - 记录错误日志

## 后续开发

1. **功能扩展**
   - 支持多种提醒类型
   - 添加提醒时间设置
   - 支持群组提醒

2. **数据分析**
   - 统计充电桩使用情况
   - 分析用户行为
   - 生成报表

3. **安全加固**
   - 添加数据加密
   - 实现访问控制
   - 防止恶意请求
